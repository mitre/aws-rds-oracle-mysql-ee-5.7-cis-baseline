include_controls 'oracle-mysql-ee-5.7-cis-baseline' do
  control '1.1' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '1.2' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '1.3' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '1.4' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end
  
  control '1.5' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '2.1' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '2.2' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.1' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.2' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.3' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.4' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.5' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.6' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.7' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.8' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '3.9' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '4.3' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '4.5' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end
  
  control '4.6' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.10' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.11' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.2' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.4' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.5' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.6' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.7' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.8' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end

  control '6.9' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end
  
  control '6.12' do
    tag "check": "(AWS RDS note: AWS supports this type of plugin via the MariaDB SERVER_AUDIT plugin:
    https://aws.amazon.com/premiumsupport/knowledge-center/advanced-audit-rds-mysql-cloudwatch/)
    To assess this recommendation, execute the following SQL statement:
      SELECT LOAD_OPTION FROM information_schema.plugins WHERE PLUGIN_NAME='SERVER_AUDIT';
    The result must be FORCE_PLUS_PERMANENT"
    tag "fix": "To remediate this setting, follow these steps, configure the settings of your 
     MariaDB Audit Plugin on your AWS custom option group"
  
    query = %{SELECT LOAD_OPTION FROM information_schema.plugins WHERE PLUGIN_NAME='SERVER_AUDIT';}
    sql_session = mysql_session(attribute('user'), attribute('password'), attribute('host'), attribute('port'))

    audit_log_plugin = sql_session.query(query).stdout.strip

    describe 'The MySQL audit plugin (SERVER_AUDIT)' do
      subject { audit_log_plugin }
      it { should cmp 'FORCE_PLUS_PERMANENT' }
    end

  end

  control '7.3' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end
  
  control '7.5' do
    tag "check": "Execute the following SQL query to determine if any users have a blank password:
        SELECT user,host 
        FROM mysql.user 
        WHERE (plugin IN('mysql_native_password', 'mysql_old_password') 
          AND LENGTH(password) = 0 AND LENGTH(authentication_string) = 0);
    No rows will be returned if all accounts have a password set."

    query = %{SELECT user,host FROM mysql.user WHERE (plugin IN('mysql_native_password', 'mysql_old_password') AND LENGTH(password) = 0 AND LENGTH(authentication_string) = 0);}
    sql_session = mysql_session(attribute('user'), attribute('password'), attribute('host'), attribute('port'))
    users_with_blank_passwords = sql_session.query(query).stdout.strip

    describe 'The MySQL users with blank passwords' do
      subject { users_with_blank_passwords }
      it { should be_empty }
    end
  end

  control '7.6' do
    
    validate_password_plugin_status_query = %{SELECT plugin_status from information_schema.plugins where plugin_name like 'validate_password%'}
    validate_password_length_query = %{SELECT @@validate_password_length}
    validate_password_mixed_case_count_query = %{SELECT @@validate_password_mixed_case_count}
    validate_password_number_count_query = %{SELECT @@validate_password_number_count}
    validate_password_special_char_count_query = %{SELECT @@validate_password_special_char_count}
    validate_password_policy_query = %{SELECT @@validate_password_policy}
    validate_password_check_user_name_query = %{SELECT @@validate_password_check_user_name}
    users_wih_username_equal_to_password_query = %{SELECT User,authentication_string,Host FROM mysql.user
      WHERE authentication_string=CONCAT('*', UPPER(SHA1(UNHEX(SHA1(user)))));}

    sql_session = mysql_session(attribute('user'), attribute('password'), attribute('host'), attribute('port'))
    
    validate_password_plugin_status = sql_session.query(validate_password_plugin_status_query).stdout.strip
    validate_password_length = sql_session.query(validate_password_length_query).stdout.strip
    validate_password_mixed_case_count = sql_session.query(validate_password_mixed_case_count_query).stdout.strip
    validate_password_number_count = sql_session.query(validate_password_number_count_query).stdout.strip
    validate_password_special_char_count = sql_session.query(validate_password_special_char_count_query).stdout.strip
    validate_password_policy = sql_session.query(validate_password_policy_query).stdout.strip
    validate_password_check_user_name = sql_session.query(validate_password_check_user_name_query).stdout.strip
    users_wih_username_equal_to_password = sql_session.query(users_wih_username_equal_to_password_query).stdout.strip

    describe 'The MySQL validate_password_length variable' do
      subject { validate_password_length }
      it { should cmp >= 14 }
    end
    
    describe 'The MySQL validate_password plugin status' do
      subject { validate_password_plugin_status }
      it { should cmp 'active' }
    end

    describe 'The MySQL validate_password_mixed_case_count variable' do
      subject { validate_password_mixed_case_count }
      it { should cmp >= 1 }
    end

    describe 'The MySQL validate_password_number_count variable' do
      subject { validate_password_number_count }
      it { should cmp >= 1 }
    end

    describe 'The MySQL validate_password_special_char_count variable' do
      subject { validate_password_special_char_count }
      it { should cmp >= 1 }
    end

    describe.one do
      describe 'The MySQL validate_password_policy variable' do
        subject { validate_password_policy }
        it { should cmp 'MEDIUM' }
      end
      describe 'The MySQL validate_password_policy variable' do
        subject { validate_password_policy }
        it { should cmp 'STRONG' }
      end
    end
    
    describe.one do
      describe 'The MySQL validate_password_check_user_name variable' do
        subject { validate_password_check_user_name }
        it { should cmp 1 }
      end
      describe 'The MySQL users with their password identical to their username' do
        subject { users_wih_username_equal_to_password }
        it { should be_empty }
      end
    end
  end

  control '9.1' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on' do
      skip 'This control is not applicable on mysql within aws rds, as aws manages the operating system in which the mysql database is running on'
    end
  end
  
  control '9.2' do
    impact 0.0
    describe 'This control is not applicable on mysql within aws rds, as aws rds does not support this setting' do
      skip 'This control is not applicable on mysql within aws rds, as aws rds does not support this setting'
    end
  end

end
